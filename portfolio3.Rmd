---
title: "portfolio3"
author: "Evan O'Keefe"
date: "3/11/2022"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r DataProcessing}
library(tidyverse)
library(lubridate)

df <- read_csv("data/processed_data.csv") %>% 
  mutate(startTime = endTime - msPlayed / 1000,
         diff = startTime - lag(endTime),
         date = as.Date(endTime))
```

```{r}
session <- c(0)

sess = 0
for( i in df$diff[2:nrow(df)]){
  if( i > 1800){
    sess = sess + 1
  }
  session = c(session, sess)
}

df$session <- session
```

```{r}
sessions <- df %>% 
  group_by(session) %>% 
  summarise(startTime = min(startTime),
            endTime = max(endTime),
            songs = n()) %>% 
  mutate(duration = (endTime - startTime) / 60)
```

```{r}
days <- df %>% 
  group_by(month, date) %>% 
  summarize(listen_time = sum(msPlayed / 60000),
            songs = n())

days
```

```{r}
df %>% 
  filter(date == mdy("04/01/2021")) %>% 
  group_by(artistName) %>% 
  summarise(count = n()) %>% 
  slice_max(order_by = count, n = 1) %>% 
  pull(artistName)
```

```{r}
library(plotly)

daily_artist <- function(df, day){
  print(df %>% filter(date == day))
  df %>% 
    filter(date == day) %>% 
    group_by(artistName) %>% 
    summarise(count = n()) %>% 
    slice_max(order_by = count, n = 1) %>% 
    pull(artistName)
}

tooltip_fun <- function(df, day, seconds){
  paste("Date:", day, '\n',
        "Top Artist:", daily_artist(df, day), '\n',
        "Total Playtime:", round(seconds_to_period(seconds)))
}

line_fun <- function(df, df2, start, end){
  p <- df %>% 
    filter(date > start, date < end) %>% 
    ggplot(aes(x = date, y = listen_time)) +
      geom_point(aes(text = tooltip_fun(df2, date, listen_time * 60))) +
      geom_line()
  ggplotly(p, tooltip = c("text"))
}
```


```{r}
library(shiny)
library(shinyBS)

ui <- fluidPage(
   titlePanel("My Spotify Listening Data"),
   dateRangeInput("dateRange",
                  "Date Range:",
                  start = min(days$date),
                  end = max(days$date)),
   plotlyOutput("lineplot")
)

server <- function(input, output) {
  lineplot <- reactive({
    line_fun(days, df, input$dateRange[1], input$dateRange[2])
  })
  output$lineplot = renderPlotly(lineplot())
}

shinyApp(ui, server)
```

